{% extends 'base.html' %}
{% block content %}

<audio id="summary-audio" class="hidden"></audio>

<div id="loader" class="hidden fixed inset-0 bg-white/80 backdrop-blur-sm z-[100] flex flex-col items-center justify-center">
    <div class="w-16 h-16 border-4 border-[#6C5DD3] border-t-transparent rounded-full animate-spin mb-4"></div>
    <p class="text-[#6C5DD3] font-bold animate-pulse">generating your exam questions...</p>
</div>

<div class="bg-sky-50/50 -m-10 p-10 min-h-screen rounded-l-[2.5rem]">
    <div class="mb-10">
        <a href="{% url 'subjects:subject_detail' chapter.subject.id %}"
            class="text-sm font-bold text-[#6C5DD3] hover:underline flex items-center mb-2">
            ‚Üê Back to {{ chapter.subject.name }}
        </a>
        <h1 class="text-3xl font-bold text-gray-800">Chapter {{ chapter.chapter_number }}: {{ chapter.title }}</h1>
    </div>

    <div class="flex items-center gap-4 mb-8 bg-white/50 p-2 rounded-2xl w-max shadow-sm border border-white">
        <button class="tab-btn px-8 py-3 rounded-xl font-bold text-sm transition-all bg-[#6C5DD3] text-white shadow-md">
            ‚ú® AI Summary
        </button>
        
        <a href="{% url 'subjects:generate_exam_questions' chapter.id %}" onclick="showLoader()"
            class="tab-btn px-8 py-3 rounded-xl font-bold text-sm transition-all bg-white text-gray-600 hover:bg-indigo-50 hover:text-[#6C5DD3] border border-transparent">
             Practice Questions
        </a>
    </div>

    <div id="section-summary" class="animate-in fade-in slide-in-from-bottom-4 duration-500">
        <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-purple-50">

            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xs font-bold text-purple-400 uppercase tracking-widest">
                    Key Concepts
                </h3>
                
                {% if summary_data %}
                <button onclick="toggleSpeech({{ chapter.id }})" id="audio-btn" 
                    class="flex items-center gap-2 px-4 py-2 rounded-xl bg-purple-50 text-[#6C5DD3] font-bold text-xs hover:bg-purple-100 transition-all border border-purple-100">
                    <span id="speaker-icon">üîä</span> <span id="btn-text">Listen to Summary</span>
                    <div id="audio-spinner" class="hidden w-3 h-3 border-2 border-[#6C5DD3] border-t-transparent rounded-full animate-spin"></div>
                </button>
                {% endif %}
            </div>

            {% if summary_data %}
                <p class="mb-6 text-gray-700 leading-relaxed">{{ summary_data.summary_paragraph }}</p>

                {% for section in summary_data.points %}
                {% if section.items %}
                <h4 class="text-sm font-semibold text-purple-600 uppercase mb-2">
                    {{ section.title }}
                </h4>
                <ul class="list-disc list-inside mb-6 space-y-2 text-gray-600">
                    {% for point in section.items %}
                    <li>{{ point }}</li>
                    {% endfor %}
                </ul>
                {% endif %}
                {% endfor %}
            {% else %}
                <p class="text-red-400 italic">No summary found. Please generate one first.</p>
            {% endif %}
        </div>
    </div>
</div>

<script>
    //  Reference global elements
    const audio = document.getElementById('summary-audio');
    const btnText = document.getElementById('btn-text');
    const icon = document.getElementById('speaker-icon');
    const spinner = document.getElementById('audio-spinner');

    audio.loop = false;
    audio.autoplay = false;

    function toggleSpeech(chapterId) {
        // CASE: If audio is currently playing OR has a source loaded and is active
        if (audio.src && !audio.paused) {
            stopAudio();
            return;
        }

        // CASE: Start playing
        playAudio(chapterId);
    }

    function playAudio(chapterId) {
        // If we haven't loaded the audio yet, fetch it
        if (!audio.src || audio.src === window.location.href) {
            spinner.classList.remove('hidden');
            btnText.innerText = "Generating Voice...";
            
            // Generate the URL 
            audio.src = `/subjects/chapter/${chapterId}/audio/`;
            
            audio.oncanplaythrough = () => {
                spinner.classList.add('hidden');
                audio.play();
                updateUI(true);
            };
        } else {
            audio.play();
            updateUI(true);
        }

        // Handle errors
        audio.onerror = () => {
            console.error("Audio error occurred");
            stopAudio();
            alert("Could not load audio. Please try again.");
        };
    }

    function stopAudio() {
        audio.pause(); // Reset progress
        audio.currentTime = 0;
        audio.removeAttribute('src'); 
        audio.load();
        updateUI(false);
    }

    audio.onended = () => {
        stopAudio();
    };

    function updateUI(isPlaying) {
        if (isPlaying) {
            btnText.innerText = "Stop Listening";
            icon.innerText = "‚èπÔ∏è";
            spinner.classList.add('hidden');
        } else {
            btnText.innerText = "Listen to Summary";
            icon.innerText = "üîä";
            spinner.classList.add('hidden');
        }
    }

    function showLoader() {
        document.getElementById('loader').classList.remove('hidden');
    }
</script>
{% endblock %}