{% extends 'base.html' %}
{% block content %}
<style>
    .ai-spinner {
        width: 18px;
        height: 18px;
        border: 3px solid #e0e7ff;
        border-top: 3px solid #4f46e5;
        border-radius: 50%;
        animation: spin 0.7s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }
</style>
<div id="ai-loader" class="hidden fixed inset-0 z-[999] bg-white/80 backdrop-blur-sm
           flex items-center justify-center gap-3 text-indigo-600 text-sm font-semibold">
    <div class="ai-spinner"></div>
    Generating summary, please wait‚Ä¶
</div>

<div class="bg-sky-50/50  min-h-screen rounded-l-[2.5rem]">


    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-6">
        <div>
            <div class="flex items-center gap-3 mb-2">
                <a href="{% url 'subjects:subjects_list' %}"
                    class="text-[#6C5DD3] bg-white p-2 rounded-xl shadow-sm hover:scale-110 transition-transform">‚Üê</a>
                <h1 class="text-3xl font-bold text-gray-800">{{ subject.name }}</h1>
            </div>
            <p class="text-gray-400 font-medium ml-12">{{ subject.code }} ‚Ä¢ {{ subject.get_difficulty_display }}
                Difficulty</p>
        </div>

        <div class="flex items-center gap-4">
            <a href="{% url 'exams:start_exam' subject.id %}"
                class="bg-[#6C5DD3] text-white px-8 py-3 rounded-2xl font-bold shadow-lg shadow-indigo-100 hover:-translate-y-1 transition-all">
                üéØ Start Exam Practice on this Subject
            </a>

        </div>
    </div>

    <div class="bg-white p-8 rounded-[2.5rem] shadow-sm mb-10 flex items-center justify-between">
        <div class="flex-grow max-w-[80%]">
            <div class="flex justify-between mb-2">
                <span class="text-xs font-bold text-gray-400 uppercase tracking-widest">Total Course Progress</span>
                <span class="text-xs font-bold text-[#6C5DD3]">{{ progress|floatformat:0 }}%</span>
            </div>
            <div class="w-full h-3 bg-gray-100 rounded-full overflow-hidden">
                <div class="h-full bg-[#6C5DD3] rounded-full transition-all duration-700"
                    style="width: {{ progress }}%"></div>
            </div>
        </div>
        <p class="text-2xl font-black text-indigo-900">
            {{ completed_chapters|default:0 }}
            <span class="text-gray-300 mx-1">/</span>
            {{ total_chapters|default:0 }}
        </p>
        <p class="text-[10px] font-bold text-gray-300 uppercase tracking-wider">
            Chapters Mastered
        </p>

    </div>
<!-- timer--------- -->
<div class="bg-white p-6 rounded-xl shadow-sm border mb-6">
    <div id="timer-ui" class="flex items-center justify-between">
        <div>
            <h3 class="text-lg font-bold">Study Session</h3>
            <p id="timer-status" class="text-sm text-gray-500">Ready to start?</p>
            <p id="live-clock" class="text-2xl font-mono font-bold text-indigo-600 hidden">00:00:00</p>
        </div>
        
        <button id="session-btn" onclick="handleSession()" 
            class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition">
            Start Studying
        </button>
    </div>
</div>
<!-- timer--------- -->
    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-6 ml-2">Course Curriculum</h3>


    <button
        class="bg-green-600 text-white px-8 py-2 mb-3 rounded-2xl font-bold shadow-lg shadow-green-300 hover:-translate-y-1 transition-all"
        onclick="openAddChapterModal()"> add chapter</button>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for slot in chapter_slots %}

        {% if slot.data %}
        <!-- CHAPTER CARD -->
        <div
            class="bg-white p-6 rounded-[2rem] shadow-sm border border-transparent hover:border-purple-200 transition-all flex flex-col relative">

            <div class="flex justify-between items-start mb-4">
                <div
                    class="w-12 h-12 bg-indigo-50 text-[#6C5DD3] rounded-xl flex items-center justify-center font-bold">
                    {{ slot.number }}
                </div>
                <span class="text-[10px] font-bold
                        {% if slot.is_completed %}
                            text-green-500 bg-green-50
                        {% else %}
                            text-orange-500 bg-orange-50
                        {% endif %}
                        px-3 py-1 rounded-full uppercase">
                    {% if slot.is_completed %}Mastered{% else %}In Progress{% endif %}
                </span>
            </div>

            <h4 class="font-bold text-gray-800 mb-4">
                {{ slot.data.title|default:"Untitled Chapter" }}
            </h4>

            <div class="space-y-3 flex-grow">
                {% if slot.data.note_file %}
                <div class="flex items-center justify-between p-3 bg-sky-50 rounded-2xl text-xs">
                    <span class="text-indigo-900 font-medium truncate max-w-[120px]">
                        {{ slot.data.note_file.name }}
                    </span>
                    <a href="{{ slot.data.note_file.url }}" target="_blank" class="text-indigo-400">üëÅÔ∏è</a>
                </div>
                {% endif %}

                {% if slot.data.is_pdf %}
                <a href="{% url 'subjects:process_ai_view' slot.data.id %}" onclick="startAILoading()"
                    class="block p-3 bg-purple-50 rounded-2xl border border-purple-100 hover:bg-purple-100 transition-colors">
                    {% else %}
                    <a href="{% url 'materials:process_ai_view' slot.data.id %}" onclick="startAILoading()"
                        class="block p-3 bg-purple-50 rounded-2xl border border-purple-100 hover:bg-purple-100 transition-colors">
                        {% endif %}
                        <p class="text-[10px] font-bold text-purple-400 uppercase mb-1">AI Insights</p>
                        <p class="text-[11px] text-purple-900 leading-relaxed line-clamp-2">
                            {{ slot.summary_preview|default:"No summary generated. Click below." }}
                        </p>
                    </a>
            </div>

            <div class="mt-6 pt-4 border-t border-gray-50 flex gap-2">
                <button onclick="confirmDelete('{{ slot.data.id }}')"
                    class="flex-grow bg-red-100 hover:bg-red-200 text-[#6C5DD3] py-2 rounded-xl text-xs font-bold">
                    Delete üóëÔ∏è
                </button>
                <button onclick="openEditModal('{{ slot.data.id }}')"
                    class="flex-grow bg-gray-200 hover:bg-gray-300 text-[#6C5DD3] py-2 rounded-xl text-xs font-bold">
                    Update ‚úèÔ∏è
                </button>
                {% if slot.data.is_pdf %}
                <a href="{% url 'subjects:process_ai_view' slot.data.id %}" onclick="startAILoading()" >
                    {% else %}
                    <a href="{% url 'materials:process_ai_view' slot.data.id %}" onclick="startAILoading()"
 >
                        {% endif %}
                        <button
                            class="flex-grow bg-indigo-500 hover:bg-indigo-700 text-[#ffffff] py-2 px-2 rounded-xl text-xs font-bold">
                            View Summary ‚ú®
                        </button>
                    </a>
            </div>
        </div>

        {% else %}

        {% endif %}

        {% endfor %}




    </div>
</div>

<!-- ----------loader-------------- -->
<div id="loader"
    class="hidden fixed inset-0 bg-white/80 backdrop-blur-sm z-[100] flex flex-col items-center justify-center">
    <div class="w-16 h-16 border-4 border-[#6C5DD3] border-t-transparent rounded-full animate-spin mb-4"></div>
    <p class="text-[#6C5DD3] font-bold animate-pulse">generating your exam questions...</p>
</div>
<!-- ----------loader-------------- -->

</div>

<div id="addChapterModal"
    class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-indigo-900/40 backdrop-blur-sm">
    <div
        class="bg-white w-full max-w-lg rounded-[2.5rem] p-10 shadow-2xl transform transition-all animate-in fade-in zoom-in duration-300">
        <div class="flex justify-between items-center mb-8">
            <h3 class="text-2xl font-bold text-indigo-900">Add new Chapter </h3>
            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-xl font-bold">‚úï</button>
        </div>

        <form action="{% url 'subjects:add_chapter' subject.id %}" method="POST" enctype="multipart/form-data"
            class="space-y-6">
            {% csrf_token %}
            <input type="hidden" name="chapter_number" id="hiddenChapterNum">

            <div class="space-y-2">
                <label class="text-xs font-bold text-gray-400 uppercase tracking-widest ml-1">Chapter Title</label>
                <input type="text" id="chapter_name" name="title" required placeholder="subject name"
                    class="w-full bg-indigo-50/50 border-2 border-transparent focus:border-[#6C5DD3] px-6 py-4 rounded-2xl outline-none transition-all">
            </div>

            <div class="space-y-2">
                <label class="text-xs font-bold text-gray-400 uppercase tracking-widest ml-1">Upload Initial Notes
                    (PDF)</label>
                <div class="relative group">
                    <input type="file" name="note_file" id="file-input" accept=".pdf,.doc,.docx"
                        class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">

                    <div id="drop-zone"
                        class="bg-indigo-50 border-2 border-dashed border-indigo-200 rounded-2xl p-8 text-center group-hover:bg-indigo-100 transition-colors">
                        <span id="file-icon" class="text-3xl block mb-2">üìÑ</span>
                        <p id="file-text" class="text-sm font-medium text-indigo-400">Click or drag to upload study
                            material</p>
                        <p id="file-info" class="text-xs text-[#6C5DD3] font-bold mt-2 hidden"></p>
                    </div>
                </div>
            </div>

            <button type="submit"
                class="w-full bg-[#6C5DD3] text-white py-4 rounded-2xl font-bold shadow-lg shadow-indigo-100 hover:bg-[#5b4eb3] transition-all transform hover:-translate-y-1">
                Create Chapter & Save Note
            </button>
        </form>
    </div>


    <div id="examContainer" class="hidden fixed inset-0 bg-white z-[9999] overflow-y-auto p-10">
        <h1 class="text-2xl font-bold mb-6">Exam Mode</h1>

    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
    const currentSubjectId = "{{ subject.id }}";
    const currentSubjectName = "{{ subject.name }}";

    function handleSession() {
        const activeSession = JSON.parse(localStorage.getItem('active_study_session'));

        if (!activeSession) {
            // START: No timer
            const sessionData = {
                startTime: Date.now(),
                subjectId: currentSubjectId,
                subjectName: currentSubjectName
            };
            localStorage.setItem('active_study_session', JSON.stringify(sessionData));
            startUI(sessionData.startTime);
        } 
        else if (activeSession.subjectId === currentSubjectId) {
            // STOP: Timer is for THIS subject
            stopSession(activeSession.startTime);
        } 
        else {
            // BLOCKing Timer is for DIFFERENT subject if alredy running a timer
            Swal.fire({
                title: 'Timer Already Running!',
                text: `You are currently studying ${activeSession.subjectName}. Please end that session before starting a new one.`,
                icon: 'warning',
                confirmButtonColor: '#4F46E5'
            });
        }
    }

    function startUI(startTime) {
        const btn = document.getElementById('session-btn');
        const clock = document.getElementById('live-clock');
        const status = document.getElementById('timer-status');
        
        btn.innerText = "End Session";
        btn.classList.replace('bg-indigo-600', 'bg-red-600');
        clock.classList.remove('hidden');
        if(status) status.innerText = "Session in progress...";

        // for clearing any of existing intervals
        if (window.timerInterval) clearInterval(window.timerInterval);
        
        window.timerInterval = setInterval(() => {
            const diff = Math.floor((Date.now() - startTime) / 1000);
            const h = Math.floor(diff / 3600).toString().padStart(2, '0');
            const m = Math.floor((diff % 3600) / 60).toString().padStart(2, '0');
            const s = (diff % 60).toString().padStart(2, '0');
            clock.innerText = `${h}:${m}:${s}`;
        }, 1000);
    }

    function stopSession(startTime) {
        const endTime = Date.now();
        const durationMins = Math.round((endTime - startTime) / 60000);

        if (durationMins < 1) {
            const saveShort = confirm("This session was less than a minute. Save it anyway?");
            if (!saveShort) {
                localStorage.removeItem('active_study_session');
                location.reload();
                return;
            }
        }

        fetch("{% url 'scheduler:save_study_log' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                subject_id: currentSubjectId,
                start_time: new Date(parseInt(startTime)).toISOString(),
                duration: durationMins
            })
        })
        .then(res => res.json())
        .then(data => {
            localStorage.removeItem('active_study_session');
            location.reload();
        })
        .catch(err => {
            console.error("Error saving log:", err);
            alert("Failed to save session. Check your connection.");
        });
    }

    window.addEventListener('load', () => {
        const activeSession = JSON.parse(localStorage.getItem('active_study_session'));
        const status = document.getElementById('timer-status');
        
        if (activeSession) {
            if (activeSession.subjectId === currentSubjectId) {

                startUI(activeSession.startTime);
            } else {
                // Show warning that a session is active elsewhere
                if(status) status.innerText = `‚ö†Ô∏è You have an active session for ${activeSession.subjectName}`;
                const btn = document.getElementById('session-btn');
                btn.title = `Finish studying ${activeSession.subjectName} first`;
            }
        }
    });
</script>
<script>

    function showLoader() {
        document.getElementById('loader').classList.remove('hidden');
    }


    function startAILoading() {
        // Show loader
        document.getElementById("ai-loader").classList.remove("hidden");

        document.querySelectorAll('a[href*="process_ai"]').forEach(btn => {
            btn.classList.add("pointer-events-none", "opacity-60");
        });
    }


    // Function to handle opening the edit modal
    function openEditModal(chapterId) {
    
        window.location.href = `/subjects/chapter/${chapterId}/edit/`;
    }

    // Function to handle deletion with a confirmation prompt
    function confirmDelete(chapterId) {
        if (confirm("Are you sure you want to delete this chapter? All AI results and notes will be lost.")) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/subjects/chapter/${chapterId}/delete/`;

            // CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'csrfmiddlewaretoken';
            hiddenInput.value = csrfToken;

            form.appendChild(hiddenInput);
            document.body.appendChild(form);
            form.submit();
        }
    }


    function openAddChapterModal() {

        document.getElementById('addChapterModal').classList.remove('hidden');
    }


    // Close modal if clicking outside the white box
    window.onclick = function (event) {
        let modal = document.getElementById('addChapterModal');
        if (event.target == modal) {
            closeModal();
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        const fileInput = document.getElementById('file-input');
        const dropZone = document.getElementById('drop-zone');
        const fileText = document.getElementById('file-text');
        const fileInfo = document.getElementById('file-info');
        const fileIcon = document.getElementById('file-icon');

        fileInput.addEventListener('dragenter', () => {
            dropZone.classList.add('bg-indigo-100', 'border-[#6C5DD3]');
        });

        fileInput.addEventListener('dragleave', () => {
            dropZone.classList.remove('bg-indigo-100', 'border-[#6C5DD3]');
        });

        // 2. Handle File Selection
        fileInput.addEventListener('change', function () {
            if (fileInput.files.length > 0) {
                const fileName = fileInput.files[0].name;

                // Update UI to show success
                fileText.innerText = 'File Selected!';
                fileText.classList.replace('text-indigo-400', 'text-green-500');

                // Show the actual file name
                fileInfo.innerText = fileName;
                fileInfo.classList.remove('hidden');

                // Highlight the box
                dropZone.classList.add('bg-green-50', 'border-green-200');
                dropZone.classList.remove('bg-indigo-50', 'border-indigo-200');
            }
        });
    });

    function closeModal() {
        document.getElementById('addChapterModal').classList.add('hidden');
        // Reset form UI
        document.getElementById('file-input').value = '';
        document.getElementById('chapter_name').value = '';

        document.getElementById('file-info').classList.add('hidden');
        document.getElementById('file-icon').innerText = 'üìÑ';
        document.getElementById('file-text').innerText = 'Click or drag to upload study material';
        document.getElementById('file-text').classList.add('text-indigo-400');
        document.getElementById('drop-zone').classList.remove('bg-green-50', 'border-green-200');
    }



</script>
{% endblock %}