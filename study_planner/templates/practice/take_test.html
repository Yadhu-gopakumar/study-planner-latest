<!-- TAKE TEST PAGE -->
<!-- templates/practice/take_test.html -->
{% extends 'base.html' %}
{% block title %}Taking Test{% endblock %}
{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Timer & Progress Bar -->
    <div class="bg-white rounded-xl p-4 shadow-sm border mb-6 sticky top-0 z-10">
        <div class="flex justify-between items-center mb-2">
            <div class="flex items-center space-x-4">
                <span class="text-sm font-medium text-gray-600">Question {{ current_question }}/{{ total_questions }}</span>
                <div class="w-48 bg-gray-200 rounded-full h-2">
                    <div class="bg-purple-600 h-2 rounded-full transition-all" style="width: {{ progress_percent }}%"></div>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2">
                    <span class="text-2xl">‚è±Ô∏è</span>
                    <span class="text-lg font-bold text-gray-900" id="timer">{{ remaining_time }}</span>
                </div>
                <button onclick="confirmSubmit()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm font-medium">
                    Submit Test
                </button>
            </div>
        </div>
    </div>

    <form method="POST" id="testForm" class="space-y-6">
        {% csrf_token %}
        
        {% for question in questions %}
        <div class="bg-white rounded-xl p-8 shadow-sm border question-card" data-question="{{ forloop.counter }}"
             style="display: {% if forloop.first %}block{% else %}none{% endif %};">
            
            <div class="mb-6">
                <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-xs font-medium">
                    Question {{ forloop.counter }}
                </span>
            </div>

            <h2 class="text-xl font-semibold text-gray-900 mb-6 leading-relaxed">
                {{ question.question_text }}
            </h2>

            <div class="bg-gray-50 rounded-lg p-6 mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-3">Your Answer:</label>
                <textarea name="answer_{{ question.id }}" rows="8" 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                    placeholder="Write your answer here... (2-5 sentences)"
                    required></textarea>
                <p class="text-xs text-gray-500 mt-2">üí° Tip: Be clear and concise. Include key points.</p>
            </div>

            <div class="flex justify-between items-center pt-4">
                <button type="button" onclick="previousQuestion({{ forloop.counter }})" 
                    class="flex items-center px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium
                    {% if forloop.first %}invisible{% endif %}">
                    ‚Üê Previous
                </button>
                
                <div class="flex space-x-2">
                    {% for i in questions %}
                    <button type="button" onclick="goToQuestion({{ forloop.counter }})"
                        class="w-10 h-10 rounded-lg border-2 question-nav font-medium
                        {% if forloop.first %}border-purple-600 bg-purple-50 text-purple-600{% else %}border-gray-300 text-gray-600{% endif %}"
                        data-nav="{{ forloop.counter }}">
                        {{ forloop.counter }}
                    </button>
                    {% endfor %}
                </div>

                <button type="button" onclick="nextQuestion({{ forloop.counter }})" 
                    class="flex items-center px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-medium
                    {% if forloop.last %}hidden{% endif %}">
                    Next ‚Üí
                </button>
                
                {% if forloop.last %}
                <button type="button" onclick="confirmSubmit()" 
                    class="flex items-center px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">
                    Submit Test ‚úì
                </button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </form>

    <!-- Confirmation Modal -->
    <div id="submitModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-md">
            <h3 class="text-xl font-bold mb-4">Submit Test?</h3>
            <p class="text-gray-600 mb-6">Are you sure you want to submit? You won't be able to change your answers.</p>
            <div class="flex space-x-4">
                <button onclick="submitTest()" class="flex-1 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 font-medium">
                    Yes, Submit
                </button>
                <button onclick="closeModal()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg hover:bg-gray-300 font-medium">
                    Continue Test
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentQuestion = 1;
const totalQuestions = {{ total_questions }};
let timeRemaining = {{ duration_seconds }};

// Timer
setInterval(() => {
    if (timeRemaining > 0) {
        timeRemaining--;
        const minutes = Math.floor(timeRemaining / 60);
        const seconds = timeRemaining % 60;
        document.getElementById('timer').textContent = 
            `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        
        if (timeRemaining <= 60) {
            document.getElementById('timer').classList.add('text-red-600');
        }
    } else {
        alert('Time is up! Submitting test...');
        submitTest();
    }
}, 1000);

function showQuestion(num) {
    document.querySelectorAll('.question-card').forEach(card => {
        card.style.display = 'none';
    });
    document.querySelector(`[data-question="${num}"]`).style.display = 'block';
    
    document.querySelectorAll('.question-nav').forEach(btn => {
        btn.classList.remove('border-purple-600', 'bg-purple-50', 'text-purple-600');
        btn.classList.add('border-gray-300', 'text-gray-600');
    });
    document.querySelector(`[data-nav="${num}"]`).classList.add('border-purple-600', 'bg-purple-50', 'text-purple-600');
    document.querySelector(`[data-nav="${num}"]`).classList.remove('border-gray-300', 'text-gray-600');
    
    currentQuestion = num;
}

function nextQuestion(current) {
    if (current < totalQuestions) {
        showQuestion(current + 1);
    }
}

function previousQuestion(current) {
    if (current > 1) {
        showQuestion(current - 1);
    }
}

function goToQuestion(num) {
    showQuestion(num);
}

function confirmSubmit() {
    document.getElementById('submitModal').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('submitModal').classList.add('hidden');
}

function submitTest() {
    document.getElementById('testForm').submit();
}

// Auto-save answers
setInterval(() => {
    const formData = new FormData(document.getElementById('testForm'));
    // You can implement auto-save to localStorage here
}, 30000); // Every 30 seconds
</script>
{% endblock %}