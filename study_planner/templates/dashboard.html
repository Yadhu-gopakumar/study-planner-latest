{% extends 'base.html' %}
{% block content %}
<div class="flex flex-col lg:flex-row gap-6 min-h-full">

    <div class="flex-grow lg:w-3/4 bg-sky-50/50 -m-10 p-10 rounded-l-[2.5rem]">
        <div class="flex justify-between items-center mb-8">
            <div>
                <h2 class="text-3xl font-bold text-gray-800">Hi, {{request.user.first_name}}</h2>
                <p class="text-gray-400 text-sm mt-1">Manage and track your learning progress</p>
            </div>
            <div class="flex items-center space-x-3">


            </div>
        </div>


        <div class="space-y-6">

            {% for item in today_schedule %}
            <div
                class="bg-white p-6 rounded-[2rem] shadow-sm flex items-center justify-between group hover:translate-y-[-2px] transition-all">
                <div class="flex items-center space-x-6">
                    <div class="w-20 h-20 bg-indigo-50 rounded-2xl flex items-center justify-center text-3xl">
                        {% if "Operating" in item.subject.name %}ðŸ’»{% else %}ðŸ“š{% endif %}
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-indigo-900">{{ item.subject.name }}</h3>
                        <p class="text-gray-400 text-xs mt-1 max-w-xs leading-relaxed">
                            Active study session for {{ item.subject.name }}.
                        </p>
                        <p class="text-[10px] font-bold text-gray-300 uppercase tracking-widest mt-3">Priority: {{
                            item.priority }}</p>
                    </div>
                </div>
                <button
                    class="w-10 h-10 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center group-hover:bg-[#6C5DD3] group-hover:text-white transition-all">
                    â†’
                </button>
            </div>
            {% endfor %}

            <div class="bg-white rounded-xl shadow border p-5">
                <h2 class="text-lg font-semibold mb-4">ðŸ•˜ Todayâ€™s Timetable</h2>

                {% if timetable_entries %}
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <tr class="bg-gray-100">
                            <th class="text-start pl-5">Time</th>
                            <th class="text-start pl-5">Subject</th>
                            <th class="text-start pl-5">Type</th>
                        </tr>

                        {% for entry in timetable_entries %}
                        <tr class="{% if entry.is_break %}bg-white{% else %}bg-yellow-100{% endif %}">
                            <td class="px-4 py-2 font-mono">
                                {{ entry.start_time|time:"H:i" }} â€“ {{ entry.end_time|time:"H:i" }}
                            </td>
                            <td class="px-4 py-2">{{ entry.subject }}</td>
                            <td class="px-4 py-2">
                                {% if entry.is_break %}Break{% else %}Study{% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </table>

                </div>
                {% else %}
                <p class="text-gray-400 text-sm">No timetable entries for today</p>
                {% endif %}
            </div>

            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mt-10 mb-4">Your Subjects</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                {% for subject in subjects %}
                <div
                    class="bg-white p-6 rounded-[2rem] shadow-sm group hover:scale-[1.02] transition-all border border-transparent hover:border-purple-100 flex flex-col justify-between">
                    <div>
                        <div class="flex justify-between items-start mb-4">
                            <div
                                class="w-14 h-14 {% if subject.difficulty == 3 %}bg-red-50 text-red-500{% elif subject.difficulty == 2 %}bg-orange-50 text-orange-500{% else %}bg-green-50 text-green-500{% endif %} rounded-2xl flex items-center justify-center text-2xl">
                                {% if subject.difficulty == 3 %}ðŸ§ {% elif subject.difficulty == 2 %}ðŸ“š{% else %}ðŸŒ±{%endif %}
                            </div>
                            <span
                                class="text-[10px] font-bold px-3 py-1 rounded-full uppercase tracking-widest 
                    {% if subject.difficulty == 3 %}bg-red-50 text-red-500{% elif subject.difficulty == 2 %}bg-orange-50 text-orange-500{% else %}bg-green-50 text-green-500{% endif %}">
                                {{ subject.get_difficulty_display }}
                            </span>
                        </div>

                        <p class="text-[10px] font-bold text-gray-300 uppercase tracking-widest">{{ subject.code }}</p>
                        <h3 class="text-lg font-bold text-indigo-900 mb-4">{{ subject.name }}</h3>

                        <div class="space-y-2 mb-6">
                            <div class="flex justify-between text-[11px] font-bold">
                                <span class="text-gray-400 uppercase tracking-tighter">Progress</span>
                                <span class="text-indigo-600">{{ subject.completed_chapters }}/{{subject.total_chapters}} Ch.</span>
                            </div>
                            <div class="w-full h-2 bg-gray-100 rounded-full overflow-hidden">
                                <div class="h-full bg-[#6C5DD3] rounded-full transition-all duration-700"
                                    style="width: {{ subject.progress_percent }}%">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center justify-between mt-auto pt-4 border-t border-gray-50">
                        <p class="text-[10px] text-gray-400">Added {{ subject.created_at | date:"M d" }}</p>
                        <button class="text-[#6C5DD3] text-sm font-bold hover:underline">View Notes</button>
                    </div>
                </div>
                {% empty %}

                <div
                    class="col-span-full py-12 bg-white/50 rounded-[2rem] border-2 border-dashed border-sky-100 text-center">
                    <p class="text-gray-400 italic">No subjects added yet </p>
                </div>

                {% endfor %}
            </div>



        </div>
    </div>

    <div class="lg:w-1/4 py-2 flex flex-col space-y-5 min-w-[260px]">
        <div class="flex items-center justify-end space-x-3 mb-4">
            <div class="text-right">
                <p class="font-bold text-gray-800 text-sm leading-tight">{{ user.first_name|default:user.email }}</p>
                <p class="text-[10px] font-medium text-gray-400">{{ user.email|truncatechars:20 }}</p>
            </div>
            <div
                class="w-10 h-10 rounded-full bg-blue-400 border-2 border-white shadow-md flex items-center justify-center text-white text-xs font-bold">
                {{ user.first_name|slice:":1"|upper }}
            </div>
        </div>
        <div class="bg-white rounded-[2rem] p-5 shadow-sm overflow-hidden">
            <div id="calendar-container" class="w-full">
                <div id="calendar"></div>
            </div>
        </div>

        <style>
            /* ===== Calendar Container ===== */
            #calendar-container {
                width: 100%;
                min-width: 220px;
                padding: 10px;
            }

            /* ===== FullCalendar Base ===== */
            #calendar,
            .fc,
            .fc-view-harness,
            .fc-scrollgrid,
            .fc-scrollgrid table,
            .fc-scrollgrid-sync-table,
            .fc .fc-daygrid-body {
                width: 100% !important;
            }

            .fc {
                font-family: 'Poppins', sans-serif;
                max-width: 100%;
            }

            /* ===== Remove Borders (Flat App Look) ===== */
            .fc-theme-standard td,
            .fc-theme-standard th,
            .fc-scrollgrid {
                border: none !important;
            }

            /* ===== Toolbar ===== */
            .fc-toolbar-title {
                font-size: 0.9rem !important;
                font-weight: 700;
                color: #312E81;
            }

            /* ===== Navigation Buttons ===== */
            .fc .fc-button-primary {
                background-color: #f3f4f6 !important;
                border: none !important;
                color: #312E81 !important;
                border-radius: 8px !important;
                padding: 4px 8px !important;
                transition: background-color 0.2s ease;
            }

            .fc .fc-button-primary:hover {
                background-color: #e5e7eb !important;
            }

            /* ===== Column Headers ===== */
            .fc-col-header-cell-cushion {
                font-size: 10px;
                padding: 5px 0 !important;
                color: #9CA3AF !important;
            }

            /* ===== Day Cells ===== */
            .fc-daygrid-day {
                transition: background-color 0.15s ease;
            }

            .fc-daygrid-day:hover {
                background-color: #f9fafb;
                cursor: pointer;
            }

            /* Center day number */
            .fc-daygrid-day-top {
                justify-content: center !important;
            }

            /* Day number */
            .fc-daygrid-day-number {
                font-size: 11px !important;
                padding: 8px !important;
                display: block;
                text-align: center;
                width: 100%;
                font-weight: 500;
                color: #4B5563;
            }

            /* ===== Today Highlight ===== */
            .fc-day-today {
                background-color: #EEF2FF !important;
                border-radius: 12px;
            }

            /* ===== Events (Compact Pills) ===== */
           /* Make all calendar events look like pills */
.fc-event {
    border-radius: 50px !important; /* Forces the capsule shape */
    padding: 3px 10px !important;
    border: none !important;
    margin-top: 2px !important;
    margin-bottom: 2px !important;
    font-family: 'Poppins', sans-serif;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Ensure All-Day events (Exams) also follow the styling */
.fc-daygrid-block-event {
    border-radius: 50px !important;
}

/* Adjust the title inside the event */
.fc-event-title {
    font-size: 11px !important;
    font-weight: 600 !important;
    color: white !important;
}

/* Style for the day cell to look cleaner */
.fc-daygrid-day.fc-day-today {
    background-color: #f0f4ff !important;
    border-radius: 10px;
}
            .fc-event-main {
                color: #ffffff !important;
            }

            /* Prevent calendar height jump */
            .fc-daygrid-event-harness {
                margin: 0 4px !important;
            }
        </style>


    </div>
</div>
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const calendarEl = document.getElementById('calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            dayMaxEvents: 2, // ðŸ‘ˆ This is the magic line. Show only 2 events per day.
            moreLinkClick: 'popover', // Opens a nice floating box when clicked
    // Add this block to format the time
    eventTimeFormat: { 
        hour: 'numeric',
        minute: '2-digit',
        meridiem: 'short', // shows 'am/pm'
        hour12: true       // set to false for 24-hour clock (18:00)
    },
            handleWindowResize: true,
            contentHeight: 'auto',
            headerToolbar: {
                left: 'title',
                center: '',
                right: 'prev,next'
            },
            height: 'auto',
            fixedWeekCount: false,
            // This is where you pull events from your Django View
            events: '/api/get-schedule-events/',

            eventClick: function (info) {
                Swal.fire({
                    title: info.event.title,
                    html: `
            <div style="text-align: left; font-family: 'Poppins', sans-serif;">
                <p><b>time:</b> ${info.event.start.toLocaleTimeString() || ''}</p>
                <p><b>Details:</b> ${info.event.extendedProps.description || 'No description provided.'}</p>
            </div>
        `,
                    icon: 'info',
                    confirmButtonColor: '#312E81',
                    confirmButtonText: 'Got it!',
                    buttonsStyling: true,
                    customClass: {
                        popup: 'rounded-[2rem]', // Tailwind class if using it
                    }
                });
            },
            dayCellDidMount: function (info) {
                // Remove the default hover effects to keep it clean
            }
        });
        calendar.render();
    });
</script>
{% endblock %}
{% endblock %}