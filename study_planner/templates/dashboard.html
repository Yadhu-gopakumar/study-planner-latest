{% extends 'base.html' %}
{% block content %}
<div class="flex flex-col lg:flex-row gap-6 min-h-full">

    <div class="flex-grow lg:w-3/4 bg-sky-50/50 -m-10 p-10 rounded-l-[2.5rem]">
        <div class="flex justify-between items-center mb-8">
            <div>
                <h2 class="text-3xl font-bold text-gray-800">Hi, {{request.user.first_name}}</h2>
                <p class="text-gray-400 text-sm mt-1">Manage and track your learning progress</p>
            </div>
            <div class="flex items-center space-x-3">
                
                <div class="flex items-center space-x-3">
                    <form action="" method="GET" class="relative">
                        <input type="text" name="search" placeholder="Search subjects..."
                            value="{{ request.GET.search }}"
                            class="bg-white border-none rounded-xl px-4 py-2 text-sm shadow-sm focus:ring-2 focus:ring-purple-200">
                        <button type="submit" class="absolute right-2 top-2 text-gray-400">üîç</button>
                    </form>
                </div>
                 <button
                    class="p-3 bg-white rounded-xl shadow-sm text-gray-400 hover:text-[#6C5DD3] transition-colors">üîî</button>
            </div>
        </div>

        <div class="flex items-center gap-4 mb-10 overflow-x-auto pb-2">
            <span class="text-gray-400 text-sm font-medium">Filter by:</span>

            <select id="difficultyFilter" onchange="location.href='?difficulty=' + this.value"
                class="bg-white border-none rounded-full px-6 py-2 text-sm shadow-sm font-medium text-gray-600 focus:ring-2 focus:ring-purple-200 cursor-pointer">
                <option value="">All Levels</option>
                <option value="1" {% if request.GET.difficulty ==  "1" %}selected{% endif %}>Easy</option>
                <option value="2" {% if request.GET.difficulty == "2" %}selected{% endif %}>Medium</option>
                <option value="3" {% if request.GET.difficulty == "3" %}selected{% endif %}>Hard</option>
            </select>
          
        </div>

        <div class="space-y-6">

            {% for item in today_schedule %}
            <div
                class="bg-white p-6 rounded-[2rem] shadow-sm flex items-center justify-between group hover:translate-y-[-2px] transition-all">
                <div class="flex items-center space-x-6">
                    <div class="w-20 h-20 bg-indigo-50 rounded-2xl flex items-center justify-center text-3xl">
                        {% if "Operating" in item.subject.name %}üíª{% else %}üìö{% endif %}
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-indigo-900">{{ item.subject.name }}</h3>
                        <p class="text-gray-400 text-xs mt-1 max-w-xs leading-relaxed">
                            Active study session for {{ item.subject.name }}.
                        </p>
                        <p class="text-[10px] font-bold text-gray-300 uppercase tracking-widest mt-3">Priority: {{
                            item.priority }}</p>
                    </div>
                </div>
                <button
                    class="w-10 h-10 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center group-hover:bg-[#6C5DD3] group-hover:text-white transition-all">
                    ‚Üí
                </button>
            </div>
            {% endfor %}

            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mt-10 mb-4">Your Subjects</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                {% for subject in subjects %}
                <div
                    class="bg-white p-6 rounded-[2rem] shadow-sm group hover:scale-[1.02] transition-all border border-transparent hover:border-purple-100 flex flex-col justify-between">
                    <div>
                        <div class="flex justify-between items-start mb-4">
                            <div
                                class="w-14 h-14 {% if subject.difficulty == 3 %}bg-red-50 text-red-500{% elif subject.difficulty == 2 %}bg-orange-50 text-orange-500{% else %}bg-green-50 text-green-500{% endif %} rounded-2xl flex items-center justify-center text-2xl">
                                {% if subject.difficulty == 3 %}üß†{% elif subject.difficulty == 2 %}üìö{% else %}üå±{% endif %}
                            </div>
                            <span
                                class="text-[10px] font-bold px-3 py-1 rounded-full uppercase tracking-widest 
                    {% if subject.difficulty == 3 %}bg-red-50 text-red-500{% elif subject.difficulty == 2 %}bg-orange-50 text-orange-500{% else %}bg-green-50 text-green-500{% endif %}">
                                {{ subject.get_difficulty_display }}
                            </span>
                        </div>

                        <p class="text-[10px] font-bold text-gray-300 uppercase tracking-widest">{{ subject.code }}</p>
                        <h3 class="text-lg font-bold text-indigo-900 mb-4">{{ subject.name }}</h3>

                        <div class="space-y-2 mb-6">
                            <div class="flex justify-between text-[11px] font-bold">
                                <span class="text-gray-400 uppercase tracking-tighter">Progress</span>
                                <span class="text-indigo-600">{{ subject.completed_chapters }}/{{ subject.total_chapters}} Ch.</span>
                            </div>
                            <div class="w-full h-2 bg-gray-100 rounded-full overflow-hidden">
                                <div class="h-full bg-[#6C5DD3] rounded-full transition-all duration-700"
                                    style="width: {{ subject.progress_percent }}%">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center justify-between mt-auto pt-4 border-t border-gray-50">
                        <p class="text-[10px] text-gray-400">Added {{ subject.created_at|date:"M d" }}</p>
                        <button class="text-[#6C5DD3] text-sm font-bold hover:underline">View Notes</button>
                    </div>
                </div>
               {% empty %}

                <div
                    class="col-span-full py-12 bg-white/50 rounded-[2rem] border-2 border-dashed border-sky-100 text-center">
                    <p class="text-gray-400 italic">No subjects added yet. Click "+ Add Subject" to begin.</p>
                </div>
                
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="lg:w-1/4 py-2 flex flex-col space-y-5 min-w-[260px]">
        <div class="flex items-center justify-end space-x-3 mb-4">
            <div class="text-right">
                <p class="font-bold text-gray-800 text-sm leading-tight">{{ user.first_name|default:user.email }}</p>
                <p class="text-[10px] font-medium text-gray-400">{{ user.email|truncatechars:20 }}</p>
            </div>
            <div
                class="w-10 h-10 rounded-full bg-blue-400 border-2 border-white shadow-md flex items-center justify-center text-white text-xs font-bold">
                {{ user.first_name|slice:":1"|upper }}
            </div>
        </div>
        <div class="bg-white rounded-[2rem] p-5 shadow-sm overflow-hidden">
            <div id="calendar-container" class="w-full">
                <div id="calendar"></div>
            </div>
        </div>

        <style>
            #calendar {
                width: 100% !important;
            }

            .fc-view-harness {
                width: 100% !important;
            }

            .fc-scrollgrid,
            .fc-scrollgrid table {
                width: 100% !important;
                table-layout: fixed !important;
            }


            #calendar-container {
                width: 100%;
                min-width: 220px;
                /* Prevents it from getting too tiny on small laptops */
            }

            .fc {
                font-family: 'Poppins', sans-serif;
                max-width: 100%;
            }

            /* Adjust the spacing between dates so they aren't squashed */
            .fc .fc-daygrid-body {
                width: 100% !important;
            }

            .fc-scrollgrid-sync-table {
                width: 100% !important;
            }

            /* Header Styling */
            .fc-toolbar-title {
                font-size: 0.9rem !important;
                font-weight: 700;
                color: #312E81;
            }

            /* Column Headers (Mon, Tue, etc.) */
            .fc-col-header-cell-cushion {
                font-size: 10px;
                padding: 5px 0 !important;
                color: #9CA3AF !important;
            }

            /* Day Numbers */
            .fc-daygrid-day-number {
                font-size: 11px !important;
                padding: 10px !important;
                display: block;
                text-align: center;
                width: 100%;
            }

            /* Remove borders for that flat "App" look */
            .fc-theme-standard td,
            .fc-theme-standard th,
            .fc-scrollgrid {
                border: none !important;
            }

            /* Event dots (to keep the calendar from getting taller with events) */
            .fc-daygrid-event-harness {
                margin: 0 4px !important;
            }
        </style>


    </div>
</div>
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const calendarEl = document.getElementById('calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            handleWindowResize: true,
            contentHeight: 'auto',
            headerToolbar: {
                left: 'title',
                center: '',
                right: 'prev,next'
            },
            height: 'auto',
            fixedWeekCount: false,
            // This is where you pull events from your Django View
            events: '/api/get-schedule-events/',

            eventClick: function (info) {
                alert('Event: ' + info.event.title);
                // You can open a modal here to show study details
            },
            dayCellDidMount: function (info) {
                // Remove the default hover effects to keep it clean
            }
        });
        calendar.render();
    });
</script>
{% endblock %}
{% endblock %}